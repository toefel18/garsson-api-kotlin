/*
 * This file was generated by the Gradle 'init' task.
 *
 * This is a general purpose Gradle build.
 * Learn how to create Gradle builds at https://guides.gradle.org/creating-new-gradle-builds/
 */

plugins {
    id "base"
    id "idea"
    id "org.jetbrains.kotlin.jvm" version "1.3.30"
    id "com.peterabeles.gversion" version "1.5.0"
}

repositories {
    mavenLocal()
    mavenCentral()
    maven { url 'https://jitpack.io' }
}

dependencies {
    compile "org.jetbrains.kotlin:kotlin-stdlib"
    compile "org.jetbrains.kotlin:kotlin-reflect"
    compile "com.fasterxml.jackson.module:jackson-module-kotlin:2.9.+"

    compile "org.slf4j:slf4j-api:1.7.25'"
    compile "ch.qos.logback:logback-classic:1.2.3"
//    compile 'io.github.microutils:kotlin-logging:1.6.20'

    compile 'io.jsonwebtoken:jjwt-api:0.10.5'
    runtime 'io.jsonwebtoken:jjwt-impl:0.10.5'
    runtime 'io.jsonwebtoken:jjwt-jackson:0.10.5'

    compile "io.undertow:undertow-core:2.0.20.Final"
    compile "io.undertow:undertow-websockets-jsr:2.0.21.Final"

    // generate typescript typings
    compile 'com.github.ntrrgc:ts-generator:1.1.1'

    testCompile 'io.kotlintest:kotlintest-runner-junit5:3.1.10'

}

gversion {
    srcDir       = "src/main/kotlin/"           // path is relative to the sub-project by default
    // Gradle variables can also be used
    // E.g. "${project.rootDir}/module/src/main/java"
    classPackage = "nl.toefel.garsson"
    className    = "BuildInfo"                // optional. If not specified GVersion is used
    dateFormat   = "yyyy-MM-dd'T'HH:mm:ss'Z'" // optional. This is the default
    timeZone     = "UTC"                      // optional. UTC is default
    debug        = false                      // optional. print out extra debug information
    language     = "kotlin"                     // optional. Can be Java or Kotlin, case insensitive
    explicitType = false                      // optional. Force types to be explicitly printed
}

task addBranchToVersionFile() {
    doLast {
        def branch = 'git rev-parse --abbrev-ref HEAD'.execute()
        branch.waitFor()
        File buildinfo = new File("src/main/kotlin/nl/toefel/garsson/BuildInfo.kt")
        buildinfo.withWriterAppend { out -> out.println("const val GIT_BRANCH = \"${branch.text.trim()}\"")}
    }
}

project.addBranchToVersionFile.dependsOn(createVersionFile)
project.compileKotlin.dependsOn(addBranchToVersionFile)

test {
    useJUnitPlatform()
}